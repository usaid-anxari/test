<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google OAuth Test - TrueTestify</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .btn {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .btn:hover { background: #0056b3; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        .status-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîó Google Business Profile Connection Test</h1>
        <p>Test the optimized Google OAuth flow for TrueTestify</p>

        <div class="status-box">
            <h3>Connection Status</h3>
            <div id="status">Click "Check Status" to see current connection</div>
        </div>

        <div>
            <button class="btn" onclick="checkStatus()">üìä Check Status</button>
            <button class="btn" onclick="startOAuth()">üîó Connect Google</button>
            <button class="btn" onclick="importReviews()">üì• Import Reviews</button>
            <button class="btn" onclick="disconnect()">‚ùå Disconnect</button>
        </div>

        <div class="status-box">
            <h3>Activity Log</h3>
            <div id="log"></div>
        </div>

        <div class="status-box">
            <h3>Instructions</h3>
            <ol>
                <li><strong>Get JWT Token:</strong> Login to get your JWT token first</li>
                <li><strong>Check Status:</strong> See if Google is already connected</li>
                <li><strong>Connect Google:</strong> Start OAuth flow (opens popup)</li>
                <li><strong>Import Reviews:</strong> Fetch Google reviews after connection</li>
            </ol>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:4000/api';
        let jwtToken = localStorage.getItem('jwt_token') || '';

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function setStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            statusDiv.innerHTML = `<span class="${className}">${message}</span>`;
        }

        async function apiCall(endpoint, options = {}) {
            if (!jwtToken) {
                jwtToken = prompt('Enter your JWT token:');
                if (jwtToken) localStorage.setItem('jwt_token', jwtToken);
            }

            const response = await fetch(`${API_BASE}${endpoint}`, {
                headers: {
                    'Authorization': `Bearer ${jwtToken}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                },
                ...options
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${await response.text()}`);
            }

            return response.json();
        }

        async function checkStatus() {
            try {
                setStatus('<div class="loading"></div> Checking connection status...', 'info');
                log('Checking Google connection status...');
                
                const status = await apiCall('/google/status');
                
                if (status.connected) {
                    setStatus(`‚úÖ Connected since ${new Date(status.connectedAt).toLocaleString()}`, 'success');
                    log(`‚úÖ Google Business Profile connected (Location: ${status.locationId})`, 'success');
                } else {
                    setStatus('‚ùå Not connected', 'error');
                    log('‚ùå Google Business Profile not connected', 'error');
                }
            } catch (error) {
                setStatus(`‚ùå Error: ${error.message}`, 'error');
                log(`‚ùå Status check failed: ${error.message}`, 'error');
            }
        }

        async function startOAuth() {
            try {
                log('üöÄ Starting Google OAuth flow...');
                setStatus('<div class="loading"></div> Getting OAuth URL...', 'info');
                
                const response = await apiCall('/google/auth-url');
                const authUrl = response.authUrl;
                
                log('üìù OAuth URL generated, opening popup...');
                setStatus('üîó Opening Google authorization...', 'info');
                
                // Open popup
                const popup = window.open(authUrl, 'google-oauth', 'width=500,height=600');
                
                // Poll for connection completion
                const pollInterval = setInterval(async () => {
                    if (popup.closed) {
                        clearInterval(pollInterval);
                        log('üîÑ Popup closed, checking connection status...');
                        
                        // Wait a moment for backend processing
                        setTimeout(async () => {
                            try {
                                const progress = await apiCall('/google/connection-progress');
                                if (progress.isConnected) {
                                    setStatus('‚úÖ Google Business Profile connected!', 'success');
                                    log('‚úÖ Connection successful!', 'success');
                                } else {
                                    setStatus('‚è≥ Connection still processing...', 'info');
                                    log('‚è≥ Connection still processing, please wait...', 'info');
                                }
                            } catch (error) {
                                setStatus(`‚ùå Connection failed: ${error.message}`, 'error');
                                log(`‚ùå Connection check failed: ${error.message}`, 'error');
                            }
                        }, 1000);
                    }
                }, 1000);
                
            } catch (error) {
                setStatus(`‚ùå OAuth failed: ${error.message}`, 'error');
                log(`‚ùå OAuth initiation failed: ${error.message}`, 'error');
            }
        }

        async function importReviews() {
            try {
                setStatus('<div class="loading"></div> Importing Google reviews...', 'info');
                log('üì• Starting Google reviews import...');
                
                const result = await apiCall('/google/import-reviews', { method: 'POST' });
                
                setStatus(`‚úÖ Imported ${result.reviewsImported} reviews`, 'success');
                log(`‚úÖ ${result.message}`, 'success');
                
                // Show reviews
                const reviews = await apiCall('/google/reviews');
                log(`üìã Found ${reviews.reviews.length} total Google reviews in database`, 'info');
                
            } catch (error) {
                setStatus(`‚ùå Import failed: ${error.message}`, 'error');
                log(`‚ùå Import failed: ${error.message}`, 'error');
            }
        }

        async function disconnect() {
            try {
                setStatus('<div class="loading"></div> Disconnecting...', 'info');
                log('üîå Disconnecting Google Business Profile...');
                
                const result = await apiCall('/google/disconnect', { method: 'DELETE' });
                
                setStatus('‚ùå Disconnected from Google', 'error');
                log('‚úÖ Successfully disconnected from Google Business Profile', 'success');
                
            } catch (error) {
                setStatus(`‚ùå Disconnect failed: ${error.message}`, 'error');
                log(`‚ùå Disconnect failed: ${error.message}`, 'error');
            }
        }

        // Auto-check status on load
        window.onload = () => {
            log('üöÄ Google OAuth Test Page loaded');
            if (jwtToken) {
                log('üîë JWT token found in localStorage');
                checkStatus();
            } else {
                log('‚ö†Ô∏è No JWT token found. Please login first.');
                setStatus('‚ö†Ô∏è Please provide JWT token to test', 'error');
            }
        };
    </script>
</body>
</html>